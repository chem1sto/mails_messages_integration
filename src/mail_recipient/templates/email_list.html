<!DOCTYPE html>
<html>
<head>
    <title>Список электронных писем</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/email_list_styles.css' %}">
    <script>
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get("email");
            if (email) {
                const ws = new WebSocket(`ws://${window.location.host}/ws/email_list/`);
                let totalEmails = 0;
                let loadedEmails = 0;
                ws.onopen = () => {
                    ws.send(JSON.stringify({ action: "fetch_emails", email: email }));
                };
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === "total_emails") {
                        totalEmails = data.total;
                        updateProgressBar(loadedEmails, totalEmails);
                    } else if (data.type === "email_list") {
                        const emails = data.email;
                        emails.forEach(email => {
                            const row = $("<tr>");
                            row.append($("<td>").text(email.subject));
                            row.append($("<td>").text(email.from));
                            row.append($("<td>").text(email.date));
                            row.append($("<td>").text(email.received));
                            row.append($("<td>").text(email.text));
                            const attachmentsCell = $("<td>");
                            if (email.attachments && email.attachments.length > 0) {
                                email.attachments.forEach(attachment => {
                                    const attachmentLink = $("<a>")
                                        .attr("href", attachment.url)
                                        .text(attachment.filename)
                                    attachmentsCell.append(attachmentLink).append("<br>");
                                });
                            } else {
                                attachmentsCell.text("Нет вложений");
                            }
                            row.append(attachmentsCell);
                            $("#email-table tbody").append(row);
                            loadedEmails++;
                            updateProgressBar(loadedEmails, totalEmails);
                        });
                    } else if (data.type === "error") {
                        $("#error-message").text(data.message);
                    }
                };
            } else {
                alert("Требуется электронная почта");
                window.location.href = "/";
            }
            function updateProgressBar(loaded, total) {
                const progress = (loaded / total) * 100;
                $("#progress-bar").width(`${progress}%`);
                $("#progress-bar").text(`${progress.toFixed(2)}%`);
            }
        });
    </script>
</head>
<body>
    <div class="header-container">
        <h1>Список электронных писем</h1>
        <button onclick="window.location.href='/'">Вернуться к стартовой странице</button>
    </div>
    <div id="error-container">
        <div id="error-message" class="error"></div>
    </div>
    <div id="progress-bar-container">
        <div id="progress-bar">0%</div>
    </div>
    <table id="email-table" border="1">
        <thead>
            <tr>
                <th>Тема сообщения</th>
                <th>Отправитель</th>
                <th>Дата отправки</th>
                <th>Дата получения</th>
                <th>Текст сообщения</th>
                <th>Вложения</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</body>
</html>
