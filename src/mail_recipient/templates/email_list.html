<html>
<head>
    <title>Email List</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get("email");
            if (email) {
                const ws = new WebSocket(`ws://${window.location.host}/ws/email_list/`);
                ws.onopen = () => {
                    ws.send(JSON.stringify({ action: "fetch_emails", email: email }));
                };
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === "email_list") {
                        const emails = data.emails;
                        const emailTable = $("#email-table tbody");
                        emailTable.empty();
                        emails.forEach(email => {
                            const row = $("<tr>");
                            row.append($("<td>").text(email.subject));
                            row.append($("<td>").text(email.from));
                            row.append($("<td>").text(email.date));
                            row.append($("<td>").text(email.received));
                            row.append($("<td>").text(email.text));
                            emailTable.append(row);
                        });
                    } else if (data.type === "error") {
                        alert(data.message);
                        window.location.href = '/?error=' + encodeURIComponent(data.message);
                    }
                };
            } else {
                alert("Требуется электронная почта");
                window.location.href = "/";
            }
        });
    </script>
</head>
<body>
    <h1>Email List</h1>
    <table id="email-table" border="1">
        <thead>
            <tr>
                <th>Тема сообщения</th>
                <th>Отправитель</th>
                <th>Дата отправки</th>
                <th>Дата получения</th>
                <th>Текст сообщения</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</body>
</html>
